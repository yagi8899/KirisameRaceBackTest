# Kirisame Race BackTest ユーザーガイド

## 📖 目次
1. [システム概要](#システム概要)
2. [主要機能](#主要機能)
3. [インストール・セットアップ](#インストールセットアップ)
4. [基本的な使い方](#基本的な使い方)
5. [詳細機能](#詳細機能)
6. [よくある質問](#よくある質問)
7. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

### 🎯 目的
**Kirisame Race BackTest** は、競馬予測モデルの性能を検証・評価するためのバックテストシステムです。

歴史的な競馬レースデータを使用して、複数の賭式（単勝・複勝・馬連・ワイド・馬単・三連複）に対する投資収益率（ROI）、的中率、利益などを分析できます。

### 🔑 核となる特徴
- **複数賭式対応**: 6種類の賭式を同時にバックテスト可能
- **パラメータ最適化**: グリッドサーチで最適な投資パラメータを自動探索
- **柔軟なフィルタリング**: 競馬場・馬場・距離・オッズ条件で絞り込み可能
- **戦略比較**: 異なるパラメータ設定の戦略を並べて比較
- **詳細レポート**: 利益推移グラフ、的中率分析、オッズ分布など複数の可視化

---

## 主要機能

### 1️⃣ データアップロード
**何ができる**: 競馬レースのTSVデータファイルをシステムに読み込む

**入力形式**:
- ファイル形式: TSV（タブ区切り）
- 必須カラム:
  - レース情報: 日付、競馬場、距離、馬場状態
  - 馬情報: 馬番号、馬名、予想オッズ、予測ランク
  - 結果: 着順、配当

**処理内容**:
- ファイル解析
- データ統計の生成（総レース数、期間、距離幅など）
- 予測精度の初期評価（1着的中率、3着以内的中率）

---

### 2️⃣ 戦略設定

#### 2-1. 賭式選択
**対応する6種類の賭式**:

| 賭式 | 説明 | 最小情報 |
|------|------|--------|
| **WIN（単勝）** | 指定馬が1着になるかどうか | 1頭 |
| **PLACE（複勝）** | 指定馬が1〜3着に入るかどうか | 1頭 |
| **BRACKET（馬連）** | 指定2頭が1・2着（順不同）に入る | 2頭 |
| **WIDE（ワイド）** | 指定2頭が3着以内に入る（順序不問） | 2頭 |
| **EXACTA（馬単）** | 指定2頭が1・2着（着順固定）に入る | 2頭 |
| **TRIO（三連複）** | 指定3頭が1〜3着に入る（順序不問） | 3頭 |

#### 2-2. パラメータ設定

| パラメータ | 意味 | 推奨値 | 例 |
|----------|------|-------|-----|
| **購入額（ベット額）** | 1つのレースで投じる金額 | 100〜1000円 | 100 |
| **TopN（対象頭数）** | 予測ランクが高い順に何頭対象にするか | 1〜3 | 1 |
| **スコア閾値** | 投資対象とする最低予測スコア | 0.0〜1.0 | 0.5 |
| **ピボット馬** | 中心となる馬を指定（複数頭対象の場合） | 馬番号 | 2 |

**例**: TopN=2, 閾値=0.5 → スコア0.5以上の上位2頭に投資

---

### 3️⃣ 詳細フィルタ設定

バックテストの対象となるレースを絞り込みます。

**フィルタ項目**:
- **競馬場**: 中山、阪神、東京など（複数選択可）
- **馬場状態**: 良、稍重、重、不良
- **距離範囲**: 〜1600m など距離の範囲指定
- **開催日期間**: 2024/1/1 〜 2024/12/31 など
- **オッズ範囲**: 推定オッズの最小〜最大

**効果**: フィルタを適用すると、バックテスト対象のレース数が減少し、特定条件下での成績を分析できます。

---

### 4️⃣ グリッドサーチ（パラメータ最適化）

**何ができる**: 購入額とTopN、スコア閾値の組み合わせを自動探索して、最も利益が大きくなる組み合わせを見つける

**実行方法**:
1. 戦略設定で大まかなパラメータ範囲を設定
2. 「グリッドサーチを実行」ボタンを押す
3. システムが複数組み合わせを試して、最適パラメータを提案

**出力**:
- 最適ROI
- 最適パラメータ値
- 各組み合わせの比較テーブル

---

### 5️⃣ 戦略比較

**何ができる**: 異なるパラメータで複数の戦略を並べて比較

**比較項目**:
- 戦略1: 購入額100, TopN=1, 閾値=0.5
- 戦略2: 購入額200, TopN=2, 閾値=0.3
- ... 最大5つまで

**出力**:
- ROI比較
- 的中率比較
- 総利益比較
- パラメータサマリーテーブル

---

### 6️⃣ バックテスト実行

**何ができる**: 設定した戦略で実際にレースデータに対して投資シミュレーション

**実行プロセス**:
1. 全レースを順序通り処理
2. 各レースで以下の判定を実施:
   - フィルタ条件に合致するか確認
   - 予測スコアがスコア閾値を超えているか確認
   - 該当レースに投資を実行
3. 結果レースで払戻金を計算
4. 累積利益を更新

**実行時間**: データサイズにより数秒〜数分

---

### 7️⃣ 結果表示

#### 7-1. サマリーカード（4項目）
- **ROI（投資収益率）**: (総利益 / 総投資額) × 100 [%]
- **的中率**: 投資したレースのうち、的中したレースの割合 [%]
- **総利益**: 配当 - 投資額の合計 [円]
- **投資レース数**: 実際に投資したレース数

#### 7-2. 収支推移グラフ
- X軸: レース番号（時系列）
- Y軸: 累積利益
- 利益が増加/減少する様子を時系列で表示
- 投資パフォーマンスの安定性を視認化

#### 7-3. ROI推移グラフ
- X軸: レース番号
- Y軸: ROI [%]
- ROIの変化を追跡
- 戦略の有効性の推移を確認

#### 7-4. 的中率分析（レーダーチャート）
- 各賭式ごとの的中率を放射状に表示
- 得意な賭式と苦手な賭式が一目瞭然

#### 7-5. オッズ分布
- X軸: 予想オッズの範囲
- Y軸: レース数
- どのオッズ帯で投資が集中しているか
- 配当効率の傾向分析に活用

#### 7-6. 詳細結果テーブル
- 投資したすべてのレースをテーブル表示
- カラム: 日付、競馬場、賭式、投資額、配当、利益/損失
- ソート・フィルタ可能

---

## インストール・セットアップ

### 前提条件
- Python 3.10以上
- Node.js 16以上（npm利用）

### 手順

#### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd KirisameRaceBackTest
```

#### 2. バックエンド環境構築
```bash
cd backend
python -m venv venv
source venv/Scripts/activate  # Windows
# または
source venv/bin/activate  # macOS/Linux

pip install -r requirements.txt
```

#### 3. フロントエンド環境構築
```bash
cd ../frontend
npm install
```

#### 4. サーバー起動

**バックエンド（ターミナル1）**:
```bash
cd backend
source venv/Scripts/activate
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**フロントエンド（ターミナル2）**:
```bash
cd frontend
npm run dev
```

#### 5. ブラウザで確認
```
http://localhost:5174
```

---

## 基本的な使い方

### 📍 ステップ1: データアップロード

1. 画面左上の「データアップロード」カードを見つける
2. 「ファイルを選択」ボタンをクリック
3. TSV形式の競馬データファイルを選択
4. 「アップロード」ボタンをクリック

**確認画面**:
- ✅ ファイル名
- ✅ ファイルサイズ
- ✅ 総レース数
- ✅ 分析対象期間
- ✅ 予測精度サマリー

---

### 📍 ステップ2: 戦略を設定

1. 「戦略設定」カードで賭式を選択
   - 例: 「単勝」または「複勝」をクリック
2. パラメータを入力:
   - 購入額: 100円 (デフォルト)
   - TopN: 1 (デフォルト)
   - スコア閾値: 0.0 (デフォルト)

---

### 📍 ステップ3: フィルタを調整（オプション）

1. 「詳細フィルタ設定」をクリック展開
2. 以下を調整:
   - **競馬場**: 中山をチェック
   - **馬場**: 良をチェック
   - **距離**: 1200m 〜 1600m
3. 変更は自動保存

---

### 📍 ステップ4: バックテスト実行

1. 画面下の「⚡ バックテストを実行」ボタンをクリック
2. 進捗表示を待つ（通常1〜5秒）
3. 完了後、結果表示エリアに以下が表示:
   - サマリーカード（4つの数値）
   - グラフ（収支推移、ROI推移など）
   - 詳細テーブル

---

### 📍 ステップ5: 結果を分析

#### ✓ ROI確認
- ROI ≥ 20% → 優秀な戦略候補
- ROI ≥ 10% → まあまあ良好
- ROI < 0% → 損失が出ている

#### ✓ 的中率確認
- 的中率 > 50% (WIN/PLACEの場合) → 予測精度が高い
- 的中率が低い場合 → スコア閾値を上げて精度の高い予測のみ投資

#### ✓ グラフから傾向を読む
- 収支推移が上昇傾向 → 安定した戦略
- 乱高下 → リスキーな戦略

---

## 詳細機能

### ROI分析グラフの活用

**シナリオ**: どの条件で本当に利益が出るのか知りたい

ROI分析グラフは、的中率だけでなく**実際の回収率**を視覚化します。

**重要：** 的中率が高い ≠ 利益が出る

**5つの分析モード**:

#### 1. 競馬場別ROI
- どの競馬場で勝ちやすいか一目でわかる
- 緑の棒グラフ＝ROI 100%以上（利益）
- 赤の棒グラフ＝ROI 100%未満（損失）
- 例：中山 125%, 京都 95% → 中山だけに絞る

#### 2. 距離別ROI
- 短距離、中距離、長距離での収益性を比較
- 1400-1799mが得意なら、その範囲にフィルタ設定

#### 3. 馬場別ROI
- 芝とダートでどちらが優れているか
- 例：芝 115%, ダート 95% → 芝レースのみ投資

#### 4. 年度別ROI
- モデルの安定性を確認
- 毎年安定して100%以上か？
- 特定年だけ高ROI → 過学習の可能性

#### 5. オッズ帯別ROI ⭐最重要
- **どのオッズ範囲で勝負すべきか**を特定
- 1.0-2.0倍：本命（的中率高いが配当低い）
- 2.1-4.0倍：準本命（バランス型）
- 4.1-8.0倍：人気薄
- 8.1倍以上：大穴
- 例：2.1-4.0倍でROI 128% → この帯だけに絞る！

**使い方**:
1. バックテスト実行後、ROI分析グラフを確認
2. 緑色（100%以上）の条件を特定
3. フィルタパネルでその条件だけに絞り込む
4. 再度バックテストで検証

**注意事項**:
- 複勝・ワイド・馬連等のオッズフィルタには制限あり（詳細はREADMEの「既知の問題」参照）
- より正確な絞り込みには「予測スコア閾値」を活用

---

### グリッドサーチの活用

**シナリオ**: 最適なパラメータを自動で見つけたい

1. 「詳細フィルタ設定」で投資対象レースを絞る
2. 「グリッドサーチ」セクションを展開
3. 探索範囲を設定:
   - 購入額: 100 〜 500円（50円刻み）
   - TopN: 1 〜 3
   - スコア閾値: 0.0 〜 0.8（0.2刻み）
4. 「グリッドサーチを実行」をクリック
5. 結果テーブルから最良の組み合わせを確認
6. 自動的にパラメータが推奨値に更新される

**時間計算**: 
- 組み合わせ数 = 購入額パターン × TopNパターン × 閾値パターン
- 例: 5 × 3 × 5 = 75組合せ → 通常 1〜2分で完了

---

### 戦略比較の活用

**シナリオ**: 2つの戦略のどちらが優れているか判断したい

1. 戦略Aのパラメータを設定してバックテスト実行
2. 結果を確認して記録
3. パラメータを変更して戦略B設定
4. 「戦略比較」セクションを展開
5. 戦略A と戦略Bの各パラメータを入力
6. 「比較を実行」をクリック
7. ROI、的中率、利益を並べて比較

---

### フィルタの組み合わせ

**例1: 中山競馬場の芝レースだけ分析**
- 競馬場: 中山 ✓
- 馬場: 良 ✓
- (距離・日期はデフォルト)

**例2: 長距離戦（2000m以上）のみ投資**
- 距離最小: 2000m
- (その他はデフォルト)

**例3: 低オッズ（1.5倍〜3.0倍）に絞った投資**
- オッズ最小: 1.5
- オッズ最大: 3.0

---

## よくある質問

### Q1: 「スコア閾値」とは何ですか？
**A**: システムが各馬に対して予測した信頼度スコア（0.0〜1.0）です。
- スコア 0.8以上 = 非常に自信ある予測
- スコア 0.5以上 = ある程度自信ある
- スコア 0.0 = 信頼度なし

スコア閾値を高く設定（例: 0.7）すると、高確度の予測のみに投資するため、的中率が上がりますが投資レース数は減ります。

---

### Q2: ROI 100%以上を目指すべきですか？
**A**: 現実的ではありません。理由:
- 競馬配当は固定ではなく、投票数に依存
- 予測精度には必ず誤差がある
- ROI 10〜20% 達成でも、銀行定期預金より優秀です

---

### Q3: 過去データでROI 50%でも、実運用で同じ結果が出ますか？
**A**: 異なります（オーバーフィッティング）。理由:
- 過去データで最適化したパラメータは、その期間に特化
- 将来データには異なるパターンが生じる
- 目安: 過去ROIの 50〜70% 程度が実運用期待値

---

### Q4: どのくらいのデータ量が必要ですか？
**A**: 推奨:
- 最小: 100レース（バックテスト精度が低い）
- 標準: 500レース以上（ある程度信頼できる）
- 理想: 1000レース以上（パターン学習に十分）

---

### Q5: 複数の賭式を同時に投資できますか？
**A**: 本システムでは、1回のバックテストで1賭式のみ分析します。複数賭式を比較する場合は、バックテストを何度も繰り返し、結果を手動で比較してください。

---

### Q6: ファイルのアップロードに失敗します
**A**: 以下を確認:
- ファイル形式が **TSV**（Excelはサポートされていません）
- 必須カラムが全て含まれている
- 文字エンコードが **UTF-8** または **Shift_JIS**
- ファイルサイズが 100MB以下

---

### Q7: バックテスト中に「サーバーエラー」が出ます
**A**: 以下を試してください:
- ブラウザのキャッシュをクリア
- バックエンドサーバーを再起動
- ファイルにNULLまたは不正なデータがないか確認

---

## トラブルシューティング

### 問題1: ファイルアップロード後、「データ概要」が表示されない

**原因考察**:
- ファイル形式が不正
- 必須カラムが不足
- ネットワーク接続の中断

**対処法**:
1. ブラウザのコンソール（F12）でエラーメッセージ確認
2. ファイルを再確認（TSV形式、必須カラムの存在）
3. バックエンドログを確認: `backend/logs/` ディレクトリ
4. ファイルを小さなサンプル（10行）で試す

---

### 問題2: グリッドサーチが「完了したが結果が0」

**原因考察**:
- フィルタ条件が厳しすぎて、対象レースがない
- スコア閾値が高すぎて、投資対象馬がない

**対処法**:
1. フィルタ条件を緩和（例: 競馬場指定を解除）
2. スコア閾値を下げる（例: 0.8 → 0.5）
3. TopNを増やす（例: 1 → 3）

---

### 問題3: ブラウザが真っ白なままで何も表示されない

**原因考察**:
- フロントエンドビルドエラー
- JavaScriptコンソールエラー
- バックエンド接続失敗

**対処法**:
1. ブラウザを再読み込み（Ctrl+Shift+R）
2. ブラウザのコンソール（F12）でエラー確認
3. npm run dev を再実行
4. ポート競合確認: `localhost:5174` が動作しているか

```bash
# ポート確認（Windows）
netstat -ano | findstr 5174

# ポート確認（macOS/Linux）
lsof -i :5174
```

---

### 問題4: 「バックテストを実行」ボタンが無反応

**原因考察**:
- データがアップロードされていない
- APIエンドポイント接続失敗
- JavaScriptエラー

**対処法**:
1. データアップロード完了を確認（「データ概要」カード表示）
2. バックエンドサーバーが起動しているか確認:
   ```bash
   curl http://localhost:8000/api/health
   ```
3. ブラウザコンソールでエラー確認（F12）
4. ネットワークタブでAPIレスポンス確認

---

### 問題5: グラフが表示されない

**原因考察**:
- データが存在しない（投資レース0件）
- グラフライブラリ（Recharts）エラー
- ブラウザ互換性問題

**対処法**:
1. 結果サマリーで投資レース数が 0 でないか確認
2. 最新ブラウザ（Chrome/Firefox）を使用
3. ブラウザ拡張機能を一時無効化

---

## パフォーマンスのコツ

### ✅ 高ROI達成のための工夫

1. **投資対象を限定する**
   - フィルタで特定競馬場・馬場に限定
   - 低オッズ帯（配当が多い）に限定

2. **スコア閾値を調整**
   - 最初は低い閾値（0.0）で試す
   - 徐々に上げて、効率性を確認

3. **TopNを実験**
   - TopN=1: 最有力馬のみ投資（高的中率だが投資数少）
   - TopN=3: 上位3頭に投資（投資増・的中率低下）

4. **グリッドサーチを活用**
   - 自動で最適パラメータを探索
   - 複数パターン比較が効率的

---

## まとめ

Kirisame Race BackTest は、競馬データを科学的に分析するツールです。

**重要ポイント**:
- ✅ 過去データでの最適化結果は、参考値に過ぎない
- ✅ 必ずマイナス結果も含めた全体分析が重要
- ✅ 短期利益より、長期安定性を目指す
- ✅ 定期的に戦略を見直す

ご質問やバグ報告は、GitHubのIssueを通じてお知らせください。

---

**最終更新**: 2026年1月13日  
**バージョン**: Phase 10
