# 競馬バックテストシステム - 要件定義書

## 1. システム概要

### 1.1 プロジェクト名
**KirisameRace BackTest System (KRBS)**

### 1.2 目的
**過去の実レースデータと予測結果を用いて、予測モデルの実際の収益性を評価するための事後分析型バックテストシステム。**

本システムは以下を目的とする：
- 機械学習による競馬予測モデルの**実際の性能（収益性）を正確に測定**
- 様々な馬券購入戦略のバックテストを実行し、**最適な購入戦略を発見**
- 確定した払戻オッズを用いた**リアルな収支シミュレーション**

**重要**: 本システムはリアルタイム予測・投資判断システムではなく、予測結果の事後評価を目的とした分析ツールである。購入判断には予測時点で得られる情報（単勝オッズ等）を使用し、払戻計算には実際の確定払戻オッズを使用することで、予測モデルの真の収益性を評価する。

### 1.3 対象ユーザー
- 競馬予測モデルの開発者
- データアナリスト
- 馬券購入戦略の研究者

---

## 2. 機能要件

### 2.1 ファイルアップロード機能 (必須)
**FR-001: TSVファイルアップロード**
- ユーザーはTSV形式の予測結果ファイルをドラッグ&ドロップまたはファイル選択でアップロード可能
- アップロード時にファイル形式の検証を実施
- 必須カラム: `競馬場`, `開催年`, `開催日`, `レース番号`, `馬番`, `馬名`, `単勝オッズ`, `人気順`, `確定着順`, `予測順位`, `予測スコア`, 各種オッズ情報
- ファイルサイズ上限: 50MB
- プログレスバー表示でアップロード状況を可視化

**FR-002: データプレビュー**
- アップロード後、データの先頭20件をテーブル表示
- データ統計情報を表示（総レース数、総馬数、期間、競馬場一覧）

### 2.2 バックテスト戦略設定機能 (必須)
**FR-003: 戦略選択**
ユーザーが以下の馬券購入戦略を選択可能:
1. **単勝戦略**
   - 予測1位の馬に単勝購入
   - 予測上位N頭に均等配分
   - 予測スコア閾値以上の馬に購入
   
2. **複勝戦略**
   - 予測1位の馬に複勝購入
   - 予測上位N頭に均等配分
   
3. **馬連戦略**
   - 予測上位2頭で馬連購入
   - 予測上位N頭のボックス買い
   
4. **ワイド戦略**
   - 予測上位2頭でワイド購入
   - 予測上位N頭のボックス買い
   
5. **馬単戦略**
   - 予測1位→2位で馬単購入
   - 予測上位N頭の軸1頭流し
   
6. **3連複戦略**
   - 予測上位3頭で3連複購入
   - 予測上位N頭のボックス買い

**FR-004: パラメータ設定**
- 1レースあたりの購入金額（100円〜10,000円）
- 購入対象頭数（N）の指定（1〜10頭）
- 予測スコア閾値（0.0〜1.0）
- 軸馬の指定（馬単・3連複用）

**FR-005: フィルタ設定**
- 競馬場フィルタ（複数選択可）
- 芝/ダートフィルタ
- 距離範囲フィルタ（1000m〜3600m）
- 日付範囲フィルタ
- オッズ範囲フィルタ（人気馬除外など）

### 2.3 バックテスト実行機能 (必須)
**FR-006: シミュレーション実行**
- 設定した戦略とパラメータでバックテストを実行
- 実行中はプログレスバーとステータス表示
- 非同期処理でUIをブロックしない
- キャンセル機能

**FR-007: 複数戦略の一括実行**
- 複数の戦略を同時に実行し、比較可能
- パラメータのグリッドサーチ機能
  - 例: 購入頭数を1〜5頭まで変化させて最適値を探索

### 2.4 結果表示機能 (必須)
**FR-008: サマリー表示**
- 総投資額
- 総払戻金
- 収支（利益/損失）
- 回収率（ROI: Return on Investment）
- 的中率
- 的中回数 / 総レース数
- 平均払戻倍率

**FR-009: グラフ表示**
モダンなインタラクティブグラフで以下を可視化:
1. **収支推移グラフ**
   - 時系列での累積収支
   - 折れ線グラフ
   
2. **回収率推移グラフ**
   - 移動平均も表示
   
3. **的中率分析グラフ**
   - 競馬場別の的中率（棒グラフ）
   - 距離別の的中率（1000～1600m / 1700m以上）
   - 芝/ダート別の的中率
   
4. **オッズ分布グラフ**
   - 的中した馬券のオッズ分布（ヒストグラム）

**FR-010: 詳細データテーブル**
- 各レースの購入履歴と結果
- ソート・フィルタ機能付き
- ページネーション（50件/ページ）
- CSV/Excelエクスポート機能

### 2.5 比較分析機能 (推奨)
**FR-011: 戦略比較**
- 複数戦略の結果を並べて比較
- 比較指標: ROI、的中率、最大ドローダウン
- レーダーチャートで視覚的に比較

### 2.6 レポート出力機能 (推奨)
**FR-012: PDF/HTMLレポート生成**
- バックテスト結果の詳細レポート
- グラフと統計情報を含む
- ダウンロード可能

---

## 3. 非機能要件

### 3.1 パフォーマンス
**NFR-001: レスポンス時間**
- ファイルアップロード: 10MBのファイルを5秒以内に処理
- バックテスト実行: 10,000レース分のデータを30秒以内に処理
- グラフ描画: 1秒以内にレンダリング

**NFR-002: 同時実行**
- 単一ユーザーが複数のバックテストを同時実行可能

### 3.2 ユーザビリティ
**NFR-003: UI/UX**
- モダンで直感的なデザイン (Phase 10で大幅改善実施)
- カード型レイアウト + 2カラムグリッドによる視覚的ヒエラルキー
- アコーディオン/折りたたみ機能による画面の整理
- レスポンシブデザイン（デスクトップ優先、タブレット対応）
- ダークモード対応
- 日本語UI
- ホバーエフェクト、トランジションによる滑らかなインタラクション

**NFR-004: アクセシビリティ**
- キーボードナビゲーション対応
- 適切なコントラスト比
- セマンティックHTML構造

### 3.3 セキュリティ
**NFR-005: データ保護**
- アップロードされたファイルは一時保存のみ（セッション終了後削除）
- CORS設定
- ファイルタイプの厳密な検証

### 3.4 互換性
**NFR-006: ブラウザサポート**
- Chrome（最新2バージョン）
- Edge（最新2バージョン）
- Firefox（最新2バージョン）
- Safari（最新2バージョン）

### 3.5 保守性
**NFR-007: コード品質**
- TypeScriptでの型安全性
- ESLint/Prettierでのコード規約統一
- ユニットテストカバレッジ70%以上
- コンポーネントの再利用性を考慮した設計

---

## 4. 制約条件

### 4.1 技術的制約
- フロントエンド: React 18+ with TypeScript
- バックエンド: FastAPI (Python 3.10+)
- データ処理: Pandas, NumPy
- グラフライブラリ: Recharts or Chart.js
- 状態管理: Zustand or Recoil
- UI: Tailwind CSS + shadcn/ui

### 4.2 データ制約
- 入力データはTSV形式のみ対応
- 文字コード: UTF-8
- 日付形式: YYYYMMDD（例: 20240127）

### 4.3 環境制約
- ローカル環境での実行を前提
- インターネット接続不要（オフライン動作）

---

## 5. 画面一覧

### 5.1 メイン画面
1. **ファイルアップロード画面**
   - ドラッグ&ドロップエリア
   - ファイル選択ボタン
   - データプレビュー

2. **戦略設定画面**
   - 戦略選択タブ
   - パラメータ入力フォーム
   - フィルタ設定パネル
   - 実行ボタン

3. **結果表示画面**
   - サマリーカード（4-6枚）
   - グラフエリア（2-4種類のグラフ）
   - 詳細データテーブル
   - エクスポートボタン

4. **比較分析画面** (オプション)
   - 複数戦略の並列表示
   - 比較チャート

---

## 6. 優先度

### P0 (必須)
- FR-001, FR-002: ファイルアップロード
- FR-003, FR-004, FR-005: 戦略設定
- FR-006: バックテスト実行
- FR-008, FR-009: 結果表示

### P1 (推奨)
- FR-007: 複数戦略実行
- FR-010: 詳細データテーブル
- FR-011: 戦略比較

### P2 (将来対応)
- FR-012: レポート出力
- ユーザー認証・データ保存機能
- リアルタイム予測連携

---

## 7. 成功基準

1. ユーザーがTSVファイルをアップロードし、5分以内にバックテスト結果を確認できる
2. 回収率100%以上の戦略を発見できる
3. グラフが視覚的に美しく、データの洞察が容易
4. エラーハンドリングが適切で、ユーザーに分かりやすいエラーメッセージが表示される

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| 回収率 (ROI) | (総払戻金 ÷ 総投資額) × 100 |
| 的中率 | (的中回数 ÷ 総購入回数) × 100 |
| 予測順位 | MLモデルが予測した馬の順位 |
| 予測スコア | MLモデルの信頼度スコア (0.0-1.0) |
| 確定着順 | 実際のレース結果の着順 |
| ボックス買い | 選択した馬の全組み合わせを購入 |
| 軸馬 | 必ず含める馬（馬単・3連複で使用） |
| ドローダウン | 最大利益からの最大下落幅 |

---

## 9. 参考資料

- 入力データサンプル: `predicted_results/predicted_results_all.tsv`
- データフォーマット: TSV (タブ区切り)、UTF-8エンコーディング

---

**作成日**: 2026年1月11日  
**バージョン**: 1.0  
**作成者**: GitHub Copilot Assistant
